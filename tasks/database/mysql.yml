---

# - debug:
#     var: "{{ item }}"
#   when: item is defined
#   loop:
#     - icingaweb_auth_backend
#     - icingaweb_auth_backend.username

- name: database configuration
  block:

    - name: create my.cnf file with password credentials
      template:
        src: my.cnf.j2
        dest: /etc/icingaweb2/.my.cnf

    # - name: create my.cnf file with password credentials
    #   file:
    #     path: /etc/icingaweb2/.my.cnf
    #     state: touch
    #
    # - name: ensure user name present
    #   ini_file:
    #     path: /etc/icingaweb2/.my.cnf
    #     section: client
    #     option: user
    #     value: "{{ icingaweb_auth_backend.username }}"
    #   no_log: true
    #
    # - name: ensure password present
    #   ini_file:
    #     path: /etc/icingaweb2/.my.cnf
    #     section: client
    #     option: password
    #     value: "{{ icingaweb_auth_backend.password }}"
    #   no_log: true
    #
    # - name: ensure socket present
    #   ini_file:
    #     path: /etc/icingaweb2/.my.cnf
    #     section: client
    #     option: socket
    #     value: "{{ icingaweb_database_socket }}"
    #   when: icingaweb_database_socket is defined
    #
    # - name: ensure socket present
    #   ini_file:
    #     path: /etc/icingaweb2/.my.cnf
    #     section: client
    #     option: host
    #     value: "{{ icingaweb_auth_backend.host }}"

    # needs root rights
    - name: ensure table_schema is created
      shell: >
        mysql \
          --user={{ icingaweb_auth_backend.username }} \
          --password={{ icingaweb_auth_backend.password }} \
          --host={{ icingaweb_auth_backend.host }} \
          --batch \
          --skip-column-names \
          --execute \
          "SELECT count(TABLE_NAME) FROM information_schema.tables where TABLE_SCHEMA = '{{ icingaweb_auth_backend.dbname }}';"
      register: mysql_icingaweb2_schema
      changed_when: false
      check_mode: false
      # no_log: true

    # database
    - name: import database schema
      mysql_db:
        state: import
        login_host: "{{ icingaweb_auth_backend.host }}"
        login_user: "{{ icingaweb_auth_backend.username }}"
        login_password: "{{ icingaweb_auth_backend.password }}"
        name: "{{ icingaweb_auth_backend.dbname }}"
        target: '{{ icingaweb_install_dir }}/etc/schema/mysql.schema.sql'
      register: icingaweb2_database_schema
      changed_when: false
      check_mode: false
      when: mysql_icingaweb2_schema.stdout | int != 4
